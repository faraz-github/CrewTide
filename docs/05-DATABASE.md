# üóÑÔ∏è CrewTide ‚Äì Database Documentation

## Schema Overview

```
auth.users (Supabase built-in)
    ‚îÇ
    ‚îî‚îÄ‚îÄ profiles (1-to-1)
            ‚îÇ
            ‚îú‚îÄ‚îÄ projects (via owner_id)
            ‚îÇ       ‚îÇ
            ‚îÇ       ‚îú‚îÄ‚îÄ project_members ‚îÄ‚îÄ‚îÄ‚îÄ profiles
            ‚îÇ       ‚îú‚îÄ‚îÄ tasks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ profiles (assigned_to, created_by)
            ‚îÇ       ‚îî‚îÄ‚îÄ project_resources ‚îÄ profiles (added_by)
```

---

## Table: profiles

Stores user display information. Links to Supabase's built-in `auth.users` table.

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID (PK) | Matches `auth.users.id` exactly |
| `name` | TEXT | User's display name |
| `email` | TEXT | User's email (unique) |
| `avatar_color` | TEXT | Hex color for avatar (e.g. `#2D6DB5`) |
| `created_at` | TIMESTAMPTZ | When they registered |

**Notes:**
- Created manually in `Auth.jsx` after `supabase.auth.signUp()`
- One profile per user
- All team members fetch each other's profiles to show names/colors

---

## Table: projects

One row per project.

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID (PK) | Auto-generated unique ID |
| `name` | TEXT | Project name |
| `description` | TEXT (nullable) | Optional description |
| `owner_id` | UUID (FK ‚Üí profiles) | Who created/owns the project |
| `invite_code` | TEXT (unique) | 8-char code for joining (e.g. `ABCD1234`) |
| `created_at` | TIMESTAMPTZ | Creation timestamp |

**Notes:**
- `invite_code` is generated by the React frontend using `generateInviteCode()` in `CreateProjectModal.jsx`
- Deleting a project cascades to delete all related tasks, members, and resources

---

## Table: project_members

Junction table ‚Äî tracks who belongs to which project.

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID (PK) | Auto-generated |
| `project_id` | UUID (FK ‚Üí projects) | Which project |
| `user_id` | UUID (FK ‚Üí profiles) | Which user |
| `role` | TEXT | `'owner'` or `'member'` |
| `joined_at` | TIMESTAMPTZ | When they joined |

**Constraints:**
- `UNIQUE(project_id, user_id)` ‚Äî Can't be a member twice
- `role` must be `'owner'` or `'member'`

**Notes:**
- When a project is created, the creator is inserted as `role = 'owner'`
- When joining via invite code, inserted as `role = 'member'`

---

## Table: tasks

All tasks within projects.

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID (PK) | Auto-generated |
| `project_id` | UUID (FK ‚Üí projects) | Which project this belongs to |
| `title` | TEXT | Task title |
| `description` | TEXT (nullable) | Optional notes |
| `assigned_to` | UUID (FK ‚Üí profiles, nullable) | Who claimed it (null = unclaimed) |
| `status` | TEXT | `'todo'`, `'in_progress'`, or `'done'` |
| `priority` | TEXT | `'low'`, `'medium'`, or `'high'` |
| `deadline` | DATE (nullable) | Optional due date |
| `created_by` | UUID (FK ‚Üí profiles) | Who created the task |
| `created_at` | TIMESTAMPTZ | Creation time |

**Status Flow:**
```
todo ‚Üí in_progress (on claim) ‚Üí done
```

**Notes:**
- Claiming a task sets `assigned_to = userId` and `status = 'in_progress'`
- Only owners can create and delete tasks
- Owner or assignee can change status

---

## Table: project_resources

Shared links within a project (the Resources Hub).

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID (PK) | Auto-generated |
| `project_id` | UUID (FK ‚Üí projects) | Which project |
| `title` | TEXT | Display name of the link |
| `url` | TEXT | The actual URL |
| `description` | TEXT (nullable) | Optional context |
| `category` | TEXT | One of: `Scope`, `Design`, `Code`, `Docs`, `Other` |
| `added_by` | UUID (FK ‚Üí profiles) | Who added it |
| `created_at` | TIMESTAMPTZ | When added |

---

## Row Level Security Summary

| Table | SELECT | INSERT | UPDATE | DELETE |
|-------|--------|--------|--------|--------|
| profiles | Everyone | Own row only | Own row only | ‚Äî |
| projects | Members only | Authenticated | Owner only | Owner only |
| project_members | Fellow members | Authenticated | ‚Äî | Owner only |
| tasks | Project members | Project owner | Project members | Project owner |
| project_resources | Project members | Project members | ‚Äî | Owner or creator |

---

## Useful SQL Queries for Debugging

### See all projects and their members:
```sql
SELECT p.name, pr.name as member_name, pm.role
FROM projects p
JOIN project_members pm ON pm.project_id = p.id
JOIN profiles pr ON pr.id = pm.user_id
ORDER BY p.name, pm.role;
```

### See all tasks with assignee names:
```sql
SELECT t.title, t.status, t.priority, pr.name as assigned_to
FROM tasks t
LEFT JOIN profiles pr ON pr.id = t.assigned_to
WHERE t.project_id = 'YOUR-PROJECT-UUID-HERE'
ORDER BY t.created_at;
```

### Find a project by invite code:
```sql
SELECT * FROM projects WHERE invite_code = 'ABCD1234';
```

### Delete all data and start fresh (‚ö†Ô∏è careful!):
```sql
TRUNCATE project_resources, tasks, project_members, projects, profiles RESTART IDENTITY CASCADE;
```

---

## How to Add a New Table

1. Write the SQL in Supabase SQL Editor:
```sql
CREATE TABLE my_new_table (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  content TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE my_new_table ENABLE ROW LEVEL SECURITY;

CREATE POLICY "select_members"
  ON my_new_table FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM project_members
      WHERE project_members.project_id = my_new_table.project_id
      AND project_members.user_id = auth.uid()
    )
  );
```

2. Create a new component in `src/components/`
3. Add it as a tab in `ProjectView.jsx`
